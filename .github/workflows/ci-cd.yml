name: CI/CD for product-service

on:
  push:
    branches:
      - dev
      - staging
      - main

env:
  SERVICE_NAME: product-service
  IMAGE_BASE: asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REPO }}

jobs:
  # ============================================================
  # 1) BUILD + PUSH IMAGE
  # ============================================================
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: |
          gcloud --quiet auth configure-docker asia-south1-docker.pkg.dev

      - name: Build & Push Docker Image
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          BRANCH="${GITHUB_REF##*/}"
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')

          TAG="${SAFE_BRANCH}-${SHORT_SHA}"
          IMAGE="${IMAGE_BASE}/${SERVICE_NAME}:${TAG}"

          echo "Building: $IMAGE"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

          # Store image for next job (artifact)
          echo "$IMAGE" > image.txt
          cat image.txt

      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-info
          path: image.txt

  # ============================================================
  # 2) DEPLOY TO GKE
  # ============================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: image-info

      - name: Load Image Name
        id: img
        run: |
          IMAGE=$(cat image.txt)
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Loaded image: $IMAGE"

      - name: FAIL if image is empty
        run: |
          if [ -z "$IMAGE" ]; then
            echo "ERROR: IMAGE is EMPTY!!!"
            exit 1
          fi

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_REGION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Determine Namespace
        id: ns
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then
            NS="leninkart-dev"
          elif [[ "$BRANCH" == "staging" ]]; then
            NS="leninkart-staging"
          else
            NS="leninkart-prod"
          fi
          echo "ns=$NS" >> $GITHUB_OUTPUT
          echo "Using namespace: $NS"

      - name: Ensure Namespace Exists
        run: |
          NS="${{ steps.ns.outputs.ns }}"
          kubectl get ns "$NS" || kubectl create ns "$NS"

      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Prepare Manifests
        run: |
          mkdir -p output
          cp k8s/deployment.yaml output/deployment.yaml
          cp k8s/service.yaml output/service.yaml

      - name: Inject Image
        run: |
          echo "Injecting image: $IMAGE"
          yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" \
            output/deployment.yaml > output/temp.yaml
          mv output/temp.yaml output/deployment.yaml

          echo "--- FINAL DEPLOYMENT YAML ---"
          cat output/deployment.yaml

      - name: Apply Manifests
        run: |
          NS="${{ steps.ns.outputs.ns }}"
          kubectl apply -n "$NS" -f output/deployment.yaml
          kubectl apply -n "$NS" -f output/service.yaml

  # ============================================================
  # 3) VERIFY ROLLOUT
  # ============================================================
  verify:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_REGION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Determine Namespace
        id: ns
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then
            NS="leninkart-dev"
          elif [[ "$BRANCH" == "staging" ]]; then
            NS="leninkart-staging"
          else
            NS="leninkart-prod"
          fi
          echo "ns=$NS" >> $GITHUB_OUTPUT

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/product-service -n "${{ steps.ns.outputs.ns }}" --timeout=300s
